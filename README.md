# Guided Symbolic Execution on edk2 using STASE 

## Step-1: Install KLEE Symbolic Execution Engine 
STASE uses KLEE as the underlying symbolic execution engine. Follow [these steps](install_klee.md) to install KLEE. These steps were tested on LLVM 13/14, Z3 constraint solver, and  Ubuntu (22.04 LTS and 23.10). 

## Step-2: Clone edk2 source code inside stase-edk2 directory
```
cd stase-edk2
git clone <Your edk2 repo> (Assuming the direcroty name will be edk2)
cd edk2
cd ..
```

## Step-3: Generate harness for symbolic execution environment
- Process header files for local communication
```
cd edk2
python3 ../process_headers.py $(pwd)
cd ..
```

- Remove macros that are incompatible with symbolic execution.
```
python3 remove_macros.py
```
- Add protocol Protocol GUIDs in static_harness file

## Step-4: Generate harness for execution control (Guided symbolic execution)

Do the following steps using the vulnerability report generated by static analysis (Examples are added in dynamic_harness directory):

- Define symbolic variables
- Substitute non-critical functions with stubs 
    Example script to generate stubs:
    ```
    python3 generate_stubs.py
    ```
- Add assertions for validation



## Step-5: Build
```
clang-13 -emit-llvm -c -g -O0 -Xclang -disable-O0-optnone stase_driver.c
```
## Step-6: Run Symbolic Execution
```
klee --external-calls=all -libc=uclibc --posix-runtime --smtlib-human-readable  --write-test-info --write-paths --write-smt2s   --write-cov  --write-cvcs --write-kqueries   --write-sym-paths --only-output-states-covering-new --use-query-log=solver:smt2  --simplify-sym-indices stase_driver.bc
```


